version: '3.8'

# Docker Compose configuration for local development
# 
# Environment variables can be overridden by creating a .env file in the root directory
# Example .env file:
#   MONGO_URI=mongodb://admin:password@mongodb:27017/muminbook?authSource=admin
#   JWT_SECRET=your-dev-secret
#   FRONTEND_URL=http://localhost:5173
#
# Or use: docker-compose --env-file .env.local up

services:
  # MongoDB Database
  mongodb:
    image: mongo:6
    container_name: muminbook-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: muminbook
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - muminbook-network

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: muminbook-backend
    restart: unless-stopped
    environment:
      NODE_ENV: development
      PORT: 5000
      MONGO_URI: ${MONGO_URI:-mongodb://admin:password@mongodb:27017/muminbook?authSource=admin}
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
    ports:
      - "5000:5000"
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      - mongodb
    networks:
      - muminbook-network
    command: npm run backend

  # Frontend React App
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: muminbook-frontend
    restart: unless-stopped
    environment:
      VITE_API_URL: http://localhost:5000/api
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - muminbook-network
    command: npm run frontend

  # Mongo Express (Database Admin UI) - Optional
  mongo-express:
    image: mongo-express:latest
    container_name: muminbook-mongo-express
    restart: unless-stopped
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
      ME_CONFIG_MONGODB_URL: mongodb://admin:password@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    ports:
      - "8081:8081"
    depends_on:
      - mongodb
    networks:
      - muminbook-network

networks:
  muminbook-network:
    driver: bridge

volumes:
  mongodb_data:
  mongodb_config:
